{% load static %}
<script id="profile-data" type="application/json">
    {{ profile_data_json|safe }}
</script>
<main id="sections-container" data-profile-data="{{ profile_data_json|safe }}">
    {% for section in sections %}
    {% include "django_d3_indicator_viz/section.html" %}
    {% endfor %}
    {% block content %}{% endblock %}
</main>

<style>
    .section-placeholder {
        min-height: 300px;
        margin-bottom: 2rem;
    }

    .loading-placeholder {
        padding: 2rem;
    }

    .skeleton-loader {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
    }

    .skeleton-chart {
        height: 250px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 8px;
    }

    @keyframes loading {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }

    .section-loaded .loading-placeholder {
        display: none;
    }
</style>

<script type="module">
    import SectionLoader from "{% static 'chart-connector.js' %}";

    // Get profile data from script tag
    const profileData = JSON.parse(document.getElementById('profile-data').textContent);

    // Store loaded sections
    const loadedSections = new Set();

    /**
     * Loads data for a section and renders its charts
     */
    async function loadSection(sectionId) {
        if (loadedSections.has(sectionId)) {
            return; // Already loaded
        }

        const article = document.querySelector(`article[data-section-id="${sectionId}"]`);
        if (!article) {
            console.error('Section article not found:', sectionId);
            return;
        }

        try {
            // Fetch section data from API
            const response = await fetch(`api/section-data/{{ primary_loc_id }}/${sectionId}/`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const sectionData = await response.json();

            // Merge profile data with section data
            const fullData = {
                ...sectionData,
                ...profileData
            };

            // Remove placeholder content
            const placeholder = article.querySelector('.loading-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            // Add section content (this will be rendered by the API or template)
            // For now, we'll assume the API returns HTML or we need to build it
            // TODO: Implement section HTML rendering

            // Load the charts using SectionLoader
            const loader = new SectionLoader(fullData);
            loader.drawAll();

            // Mark as loaded
            article.classList.add('section-loaded');
            article.classList.remove('section-placeholder');
            loadedSections.add(sectionId);

        } catch (error) {
            console.error('Error loading section:', sectionId, error);
            const placeholder = article.querySelector('.loading-placeholder');
            if (placeholder) {
                placeholder.innerHTML = '<p style="color: red;">Error loading section data</p>';
            }
        }
    }

    /**
     * Sets up Intersection Observer to load sections as they come into view
     */
    function setupLazyLoading() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const article = entry.target;
                    const sectionId = article.dataset.sectionId;
                    loadSection(sectionId);
                    observer.unobserve(article); // Stop observing once loaded
                }
            });
        }, {
            rootMargin: '100px' // Start loading 100px before section is visible
        });

        // Observe all section placeholders
        document.querySelectorAll('.section-placeholder').forEach(article => {
            observer.observe(article);
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        setupLazyLoading();
        setupDataButtons();
    });

    // Handle show/hide data button clicks
    function setupDataButtons() {
        document.querySelectorAll('.show-data-button').forEach(button => {
            // Remove any existing listeners to avoid duplicates
            button.replaceWith(button.cloneNode(true));
        });

        document.querySelectorAll('.show-data-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const indicatorId = button.dataset.indicatorId;
                const tableContainer = document.getElementById(`indicator-${indicatorId}-datatable-container`);

                if (!tableContainer) {
                    console.error('Table container not found for indicator:', indicatorId);
                    return;
                }

                const isCurrentlyHidden = tableContainer.style.display === 'none' || !tableContainer.style.display;

                // Close all other drawers first
                document.querySelectorAll('.data-drawer').forEach(drawer => {
                    drawer.style.display = 'none';
                });
                // Reset button text for buttons NOT inside drawers
                document.querySelectorAll('.show-data-button:not(.data-drawer .show-data-button)').forEach(btn => {
                    btn.textContent = 'Show data';
                });

                // Toggle the clicked one
                if (isCurrentlyHidden) {
                    tableContainer.style.display = 'block';
                    button.textContent = 'Hide data';
                }
            });
        });
    }
</script>
